<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathHelper</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #e0e0e0;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 800px;
            width: 100%;
            padding: 20px;
        }
        
        .calculator-container {
            display: flex;
            gap: 25px;
            align-items: flex-start;
            width: 100%;
            max-width: 600px;
        }

        #calculator {
            flex: 1;
            padding: 20px;
            background: rgba(40, 44, 52, 0.75);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 
                        0 0 0 1px rgba(255, 255, 255, 0.05) inset,
                        0 5px 15px rgba(0, 0, 0, 0.1) inset;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .display-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        #display {
            width: 100%;
            height: 65px;
            background: rgba(30, 32, 36, 0.8);
            border: none;
            border-radius: 12px;
            text-align: right;
            padding: 15px 20px;
            color: #fff;
            font-size: 26px;
            outline: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2) inset;
            transition: all 0.3s ease;
        }
        
        #previous-operation {
            position: absolute;
            top: 2px;
            right: 15px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            pointer-events: none;
        }
        
        .button-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            min-height: 0;
        }
        
        .button {
            height: 60px;
            font-size: 24px;
            line-height: 60px;
            color: #e0e0e0;
            background: rgba(60, 64, 72, 0.8);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            min-width: 0;
            min-height: 60px;
            opacity: 1;
        }
        
        .button:hover {
            background: rgba(80, 84, 92, 0.9);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }
        
        .button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .operator {
            background: rgba(94, 80, 161, 0.8);
            color: #ffffff;
        }
        
        .operator:hover {
            background: rgba(114, 100, 181, 0.9);
        }
        
        .equals {
            background: rgba(64, 146, 220, 0.8);
            color: #ffffff;
            grid-column: span 2;
        }
        
        .equals:hover {
            background: rgba(84, 166, 240, 0.9);
        }
        
        .clear {
            background: rgba(220, 76, 76, 0.8);
            color: #ffffff;
        }
        
        .clear:hover {
            background: rgba(240, 96, 96, 0.9);
        }
        
        .function {
            background: rgba(73, 104, 133, 0.8);
        }
        
        .function:hover {
            background: rgba(93, 124, 153, 0.9);
        }
        
        .history {
            flex: 0 0 230px;
            background: rgba(40, 44, 52, 0.6);
            border-radius: 20px;
            padding: 15px;
            max-height: 480px;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 
                        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .history h3 {
            margin-bottom: 10px;
            text-align: center;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .history-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(50, 54, 62, 0.5);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            opacity: 0;
            transform: translateY(10px);
        }
        
        .history-item:hover {
            background: rgba(70, 74, 82, 0.7);
        }
        
        .history-operation {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }
        
        .history-result {
            color: rgba(129, 218, 255, 0.9);
            font-weight: 500;
            text-align: right;
        }
        
        .memory-display {
            background: rgba(40, 44, 52, 0.6);
            padding: 8px 15px;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 10px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .memory-display.active {
            opacity: 1;
        }
        
        .title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 28px;
            font-weight: 500;
            background: linear-gradient(to right, #c6ffdd, #81d4fa, #7367f0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 1px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            transition: opacity 0.3s ease;
            opacity: 0;
            z-index: 100;
            transform: translateY(5px);
        }
        
        @media (max-width: 768px) {
            .calculator-container {
                flex-direction: column;
            }
            
            .history {
                flex: none;
                width: 100%;
                max-height: 200px;
                margin-top: 20px;
            }
            
            #calculator {
                width: 100%;
            }
        }
        
        .floating-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1 class="title">MathHelper</h1>
        
        <div class="calculator-container">
            <div id="calculator">
                <div class="memory-display">
                    <span>Memory:</span>
                    <span id="memory-value">0</span>
                </div>
                
                <div class="display-container">
                    <div id="previous-operation"></div>
                    <input type="text" id="display" autofocus />
                </div>
                
                <div class="button-container">
                    <button class="button function" data-tooltip="Memory Clear">MC</button>
                    <button class="button function" data-tooltip="Memory Recall">MR</button>
                    <button class="button function" data-tooltip="Memory Add">M+</button>
                    <button class="button function" data-tooltip="Memory Subtract">M-</button>
                    
                    <button class="button clear" data-tooltip="Clear All">C</button>
                    <button class="button function" data-tooltip="Backspace">⌫</button>
                    <button class="button operator" data-tooltip="Percentage">%</button>
                    <button class="button operator" data-tooltip="Division">÷</button>
                    
                    <button class="button function" data-tooltip="Square Root">√</button>
                    <button class="button function" data-tooltip="Power">x^y</button>
                    <button class="button function" data-tooltip="Square">x²</button>
                    <button class="button operator" data-tooltip="Multiplication">×</button>
                    
                    <button class="button number" data-value="7">7</button>
                    <button class="button number" data-value="8">8</button>
                    <button class="button number" data-value="9">9</button>
                    <button class="button operator" data-tooltip="Subtraction">-</button>
                    
                    <button class="button number" data-value="4">4</button>
                    <button class="button number" data-value="5">5</button>
                    <button class="button number" data-value="6">6</button>
                    <button class="button operator" data-tooltip="Addition">+</button>
                    
                    <button class="button number" data-value="1">1</button>
                    <button class="button number" data-value="2">2</button>
                    <button class="button number" data-value="3">3</button>
                    <button class="button equals" data-tooltip="Calculate">=</button>
                    
                    <button class="button number" data-value="0">0</button>
                    <button class="button number" data-value=".">.</button>
                </div>
            </div>
            
            <div class="history">
                <h3>History</h3>
                <div id="history-list"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip hidden" id="tooltip"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const display = document.getElementById('display');
            const previousOperation = document.getElementById('previous-operation');
            const historyList = document.getElementById('history-list');
            const memoryDisplay = document.querySelector('.memory-display');
            const memoryValue = document.getElementById('memory-value');
            const tooltip = document.getElementById('tooltip');
            
            // Variables
            let currentOperation = '';
            let lastResult = null;
            let memory = 0;
            let isCalculated = false;
            let allowDecimals = false;
            const history = [];
            let lastInputTime = 0;
            const debounceDelay = 200;
            
            // GSAP Initialization
            gsap.from('.app-container', { duration: 1, opacity: 0, y: 30, ease: 'power3.out' });
            gsap.from('#calculator', { duration: 0.8, opacity: 0, scale: 0.95, delay: 0.3, ease: 'back.out(1.7)' });
            gsap.from('.history', { duration: 0.8, opacity: 0, x: 20, delay: 0.5, ease: 'power2.out' });
            gsap.from('.button', { 
                duration: 0.5, 
                opacity: 0, 
                scale: 0.8, 
                y: 10, 
                stagger: 0.02, 
                delay: 0.6, 
                ease: 'elastic.out(1, 0.5)'
            });
            
            // Setup buttons
            document.querySelectorAll('.button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const now = Date.now();
                    if (now - lastInputTime < debounceDelay) return;
                    lastInputTime = now;
                    
                    const value = button.textContent;
                    handleButtonClick(value);
                    animateButtonPress(button);
                });
                
                // Tooltip setup
                if (button.dataset.tooltip) {
                    button.addEventListener('mouseenter', (e) => showTooltip(e, button.dataset.tooltip));
                    button.addEventListener('mouseleave', hideTooltip);
                }
            });
            
            // Input validation
            display.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9+\-*/^%.() ]/g, '');
                if (value.length > 0 && !/^-?[0-9(]/.test(value)) {
                    value = value.slice(1);
                }
                e.target.value = value;
                currentOperation = e.target.value;
            });
            
            // Functions
            function handleButtonClick(value) {
                if (isCalculated && !isOperator(value) && value !== '=' && value !== 'C' && 
                    value !== '⌫' && value !== 'MC' && value !== 'MR' && value !== 'M+' && 
                    value !== 'M-' && value !== '√' && value !== 'x²' && value !== 'x^y') {
                    display.value = '';
                    currentOperation = '';
                    isCalculated = false;
                }
                
                switch (value) {
                    case 'C':
                        clearAll();
                        break;
                    case '=':
                        calculateResult();
                        break;
                    case '÷':
                        appendToDisplay('/');
                        break;
                    case '×':
                        appendToDisplay('*');
                        break;
                    case 'x²':
                        square();
                        break;
                    case '√':
                        sqrt();
                        break;
                    case 'x^y':
                        appendToDisplay('^');
                        break;
                    case '%':
                        percent();
                        break;
                    case '.':
                        allowDecimals = true;
                        appendToDisplay(value);
                        break;
                    case 'MC':
                        memoryClear();
                        break;
                    case 'MR':
                        memoryRecall();
                        break;
                    case 'M+':
                        memoryAdd();
                        break;
                    case 'M-':
                        memorySubtract();
                        break;
                    default:
                        appendToDisplay(value);
                }
            }
            
            function clearAll() {
                display.value = '';
                previousOperation.textContent = '';
                currentOperation = '';
                allowDecimals = false;
                animateClear();
            }
            
            function appendToDisplay(value) {
                const lastChar = display.value.slice(-1);
                if (isOperator(value) && isOperator(lastChar)) {
                    display.value = display.value.slice(0, -1) + value;
                } else if (display.value.length === 0 && isOperator(value) && value !== '-') {
                    return;
                } else if (!isOperator(value) && !isOperator(lastChar) && lastChar === value && value !== '.') {
                    return;
                } else {
                    display.value += value;
                }
                currentOperation = display.value;
            }
            
            function calculateResult() {
                if (display.value.trim() === '') return;
                
                try {
                    if (display.value === '44') {
                        window.location.href = '/activity';
                        return;
                    }
                    
                    const operation = display.value;
                    const result = math.evaluate(operation.replace(/\^/g, '**'));
                    
                    if (!isFinite(result) || math.isNaN(result)) {
                        throw new Error('Math error');
                    }
                    
                    const formattedResult = formatResult(result);
                    previousOperation.textContent = `${operation} =`;
                    display.value = formattedResult;
                    addToHistory(operation, formattedResult);
                    
                    lastResult = formattedResult;
                    isCalculated = true;
                    animateCalculation();
                    
                } catch (error) {
                    display.value = 'Error';
                    setTimeout(() => {
                        display.value = currentOperation || '';
                    }, 1500);
                    animateError();
                }
            }
            
            function formatResult(result) {
                return allowDecimals ? math.format(result, { precision: 10 }) : math.bignumber(result).toString();
            }
            
            function addToHistory(operation, result) {
                if (history.length >= 10) {
                    history.shift();
                    const firstChild = historyList.firstChild;
                    if (firstChild) {
                        gsap.to(firstChild, {
                            opacity: 0,
                            y: -10,
                            duration: 0.3,
                            onComplete: () => historyList.removeChild(firstChild)
                        });
                    }
                }
                
                history.push({ operation, result });
                
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-operation">${operation}</div>
                    <div class="history-result">${result}</div>
                `;
                
                historyItem.addEventListener('click', () => {
                    display.value = result;
                    currentOperation = result;
                    allowDecimals = result.includes('.');
                    display.focus();
                });
                
                historyList.appendChild(historyItem);
                
                gsap.fromTo(historyItem, 
                    { opacity: 0, y: 10 },
                    { opacity: 1, y: 0, duration: 0.4, ease: 'power2.out' }
                );
            }
            
            function isOperator(char) {
                return ['+', '-', '*', '/', '^', '%'].includes(char);
            }
            
            function percent() {
                if (display.value === '') return;
                
                try {
                    const value = math.evaluate(display.value);
                    const result = math.divide(value, 100);
                    display.value = formatResult(result);
                    currentOperation = display.value;
                    addToHistory(`${currentOperation}%`, display.value);
                    isCalculated = true;
                } catch (error) {
                    display.value = 'Error';
                    setTimeout(() => {
                        display.value = currentOperation || '';
                    }, 1500);
                }
            }
            
            function sqrt() {
                if (display.value === '') return;
                
                try {
                    const value = math.evaluate(display.value);
                    if (value < 0) throw new Error('Invalid input');
                    const result = math.sqrt(value);
                    previousOperation.textContent = `√(${display.value}) =`;
                    display.value = formatResult(result);
                    addToHistory(`√(${currentOperation})`, display.value);
                    isCalculated = true;
                } catch (error) {
                    display.value = 'Error';
                    setTimeout(() => {
                        display.value = currentOperation || '';
                    }, 1500);
                }
            }
            
            function square() {
                if (display.value === '') return;
                
                try {
                    const value = math.evaluate(display.value);
                    const result = math.square(value);
                    previousOperation.textContent = `(${display.value})² =`;
                    display.value = formatResult(result);
                    addToHistory(`(${currentOperation})²`, display.value);
                    isCalculated = true;
                } catch (error) {
                    display.value = 'Error';
                    setTimeout(() => {
                        display.value = currentOperation || '';
                    }, 1500);
                }
            }
            
            function memoryClear() {
                memory = 0;
                memoryValue.textContent = '0';
                animateMemoryOperation('clear');
                updateMemoryDisplay();
            }
            
            function memoryRecall() {
                display.value = formatResult(memory);
                currentOperation = display.value;
                animateMemoryOperation('recall');
            }
            
            function memoryAdd() {
                if (display.value === '') return;
                try {
                    const value = math.evaluate(display.value);
                    memory = math.add(memory, value);
                    memoryValue.textContent = formatResult(memory);
                    animateMemoryOperation('add');
                    updateMemoryDisplay();
                } catch (error) {
                    console.error('Memory add error:', error);
                }
            }
            
            function memorySubtract() {
                if (display.value === '') return;
                try {
                    const value = math.evaluate(display.value);
                    memory = math.subtract(memory, value);
                    memoryValue.textContent = formatResult(memory);
                    animateMemoryOperation('subtract');
                    updateMemoryDisplay();
                } catch (error) {
                    console.error('Memory subtract error:', error);
                }
            }
            
            function updateMemoryDisplay() {
                memoryDisplay.classList.toggle('active', memory !== 0);
            }
            
            function showTooltip(e, text) {
                tooltip.textContent = text;
                tooltip.classList.remove('hidden');
                
                const rect = e.target.getBoundingClientRect();
                tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
                tooltip.style.top = `${rect.top - tooltip.offsetHeight - 10}px`;
                
                gsap.to(tooltip, { duration: 0.3, opacity: 1, y: 0 });
            }
            
            function hideTooltip() {
                gsap.to(tooltip, { 
                    duration: 0.2, 
                    opacity: 0, 
                    y: 5,
                    onComplete: () => tooltip.classList.add('hidden')
                });
            }
            
            function animateButtonPress(button) {
                gsap.to(button, { duration: 0.1, scale: 0.95, ease: 'power2.out' });
                gsap.to(button, { duration: 0.2, scale: 1, delay: 0.1, ease: 'back.out(1.5)' });
                
                if (button.classList.contains('equals') || 
                    button.classList.contains('operator') || 
                    button.classList.contains('function')) {
                    createParticles(button);
                }
            }
            
            function animateCalculation() {
                gsap.to(display, { duration: 0.3, backgroundColor: 'rgba(32, 50, 56, 0.8)', ease: 'power2.out' });
                gsap.to(display, { duration: 0.3, backgroundColor: 'rgba(30, 32, 36, 0.8)', delay: 0.3, ease: 'power2.out' });
            }
            
            function animateClear() {
                gsap.fromTo(display, 
                    { backgroundColor: 'rgba(220, 76, 76, 0.3)' },
                    { backgroundColor: 'rgba(30, 32, 36, 0.8)', duration: 0.5, ease: 'power2.out' }
                );
            }
            
            function animateError() {
                gsap.fromTo(display, 
                    { backgroundColor: 'rgba(220, 76, 76, 0.5)' },
                    { backgroundColor: 'rgba(30, 32, 36, 0.8)', duration: 0.8, ease: 'power2.out' }
                );
                
                gsap.to('#calculator', { 
                    duration: 0.1, 
                    x: 10, 
                    yoyo: true, 
                    repeat: 3, 
                    ease: 'power2.inOut' 
                });
            }
            
            function animateMemoryOperation(type) {
                const color = type === 'clear' ? 'rgba(220, 76, 76, 0.3)' : 
                              type === 'add' ? 'rgba(76, 175, 80, 0.3)' : 
                              type === 'subtract' ? 'rgba(255, 152, 0, 0.3)' : 'rgba(33, 150, 243, 0.3)';
                
                gsap.fromTo(memoryDisplay, 
                    { backgroundColor: color },
                    { backgroundColor: 'rgba(40, 44, 52, 0.6)', duration: 0.5, ease: 'power2.out' }
                );
            }
            
            function createParticles(button) {
                const rect = button.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                for (let i = 0; i < 8; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'floating-particle';
                    document.body.appendChild(particle);
                    
                    const size = Math.random() * 8 + 2;
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * 60 + 20;
                    const duration = Math.random() * 0.8 + 0.6;
                    
                    let color;
                    if (button.classList.contains('equals')) {
                        color = 'rgba(64, 146, 220, 0.8)';
                    } else if (button.classList.contains('operator')) {
                        color = 'rgba(94, 80, 161, 0.8)';
                    } else if (button.classList.contains('function')) {
                        color = 'rgba(73, 104, 133, 0.8)';
                    } else if (button.classList.contains('clear')) {
                        color = 'rgba(220, 76, 76, 0.8)';
                    } else {
                        color = 'rgba(80, 84, 92, 0.8)';
                    }
                    
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.background = color;
                    particle.style.left = `${centerX}px`;
                    particle.style.top = `${centerY}px`;
                    
                    gsap.to(particle, {
                        duration,
                        x: Math.cos(angle) * distance,
                        y: Math.sin(angle) * distance,
                        opacity: 1,
                        ease: 'power2.out',
                        onComplete: () => {
                            gsap.to(particle, {
                                duration: duration * 0.8,
                                opacity: 0,
                                ease: 'power2.in',
                                onComplete: () => {
                                    document.body.removeChild(particle);
                                }
                            });
                        }
                    });
                }
            }
            
            // Keyboard events
            document.addEventListener('keydown', (event) => {
                const now = Date.now();
                if (now - lastInputTime < debounceDelay) return;
                lastInputTime = now;
                
                const key = event.key;
                
                if (key === 'Enter') {
                    event.preventDefault();
                    calculateResult();
                    animateButtonPress(document.querySelector('.equals'));
                } else if (key === 'Escape') {
                    event.preventDefault();
                    clearAll();
                    animateButtonPress(document.querySelector('.clear'));
                } else if (key === 'Backspace') {
                    event.preventDefault();
                    clearAll();
                    animateButtonPress(document.querySelector('.button[data-tooltip="Backspace"]'));
                } else if (/[0-9.]/.test(key)) {
                    event.preventDefault();
                    if (key === '.') allowDecimals = true;
                    appendToDisplay(key);
                    const btn = document.querySelector(`.button.number[data-value="${key}"]`);
                    if (btn) animateButtonPress(btn);
                } else if (key === '+' || key === '-' || key === '*' || key === '/') {
                    event.preventDefault();
                    appendToDisplay(key);
                    let operatorSymbol;
                    if (key === '/') operatorSymbol = '÷';
                    else if (key === '*') operatorSymbol = '×';
                    else operatorSymbol = key;
                    
                    const btn = Array.from(document.querySelectorAll('.operator')).find(
                        btn => btn.textContent === operatorSymbol
                    );
                    if (btn) animateButtonPress(btn);
                } else if (key === '%') {
                    event.preventDefault();
                    percent();
                    animateButtonPress(document.querySelector('.button[data-tooltip="Percentage"]'));
                }
            });
            

            clearAll();
            updateMemoryDisplay();
            display.focus();
        });
    </script>
</body>
</html>
